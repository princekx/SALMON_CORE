<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SALMON - SEAsia Large Scale Monitoring Dashboard</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <!-- Add Flatpickr CSS for calendar -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        body { 
            padding: 0; 
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
        }
        
        .header {
            background-color: #007bff;
            color: white;
            padding: 15px 20px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            margin: 0;
            font-size: 24px;
            font-weight: bold;
        }
        
        .sidebar {
            position: fixed;
            top: 70px;
            left: 10px;
            width: 220px;
            height: calc(100vh - 80px);
            background-color: #ffffff;
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow-y: auto;
            padding: 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .sidebar .nav {
            flex-direction: column;
        }
        
        .sidebar .nav-item {
            width: 100%;
            border-bottom: 1px solid #ddd;
        }
        
        .sidebar .nav-link {
            color: #333;
            padding: 15px 20px;
            border-left: 4px solid transparent;
            transition: all 0.3s;
        }
        
        .sidebar .nav-link:hover {
            background-color: #e9ecef;
            color: #007bff;
        }
        
        .sidebar .nav-link.active {
            background-color: #007bff;
            color: white;
            border-left-color: #0056b3;
        }
        
        .main-content {
            margin-left: 240px;
            margin-top: 70px;
            margin-right: 10px;
            margin-bottom: 10px;
            padding: 20px;
            min-height: calc(100vh - 80px);
        }
        
        .tab-content {
            background: white;
            border-radius: 5px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        iframe { 
            width: 100%; 
            height: 1000px; 
            border: none; 
            margin-top: 20px; 
        }
        
        h2, h3 {
            color: #007bff;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            margin-top: 10px;
            margin-bottom: 15px;
        }
        
        h3 { 
            font-size: 16px; 
        }
        
        select.form-control { 
            width: 100%; 
        }
        
        .control-group {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        /* Calendar styling */
        .flatpickr-day.disabled {
            color: #ccc !important;
            cursor: not-allowed !important;
        }
        
        .flatpickr-input {
            cursor: pointer;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: relative;
                height: auto;
                top: 0;
                left: 0;
                margin: 10px;
            }
            
            .main-content {
                margin-left: 10px;
                margin-top: 10px;
            }
        }
    </style>
</head>

<body>

<!-- Header -->
<div class="header">
    <h1>SALMON - SEAsia Large Scale Monitoring</h1>
</div>

<!-- Sidebar Navigation -->
<div class="sidebar">
    <ul class="nav nav-pills" id="dashboardTabs" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" data-toggle="pill" href="#mjo">MJO</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-toggle="pill" href="#coldsurge">Cold Surge</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-toggle="pill" href="#eqwaves">Equatorial Waves</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-toggle="pill" href="#monsoonIndices">Monsoon Indices</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-toggle="pill" href="#convLines">Convergence Lines</a>
        </li>
    </ul>
</div>

<!-- Main Content Area -->
<div class="main-content">
    <div class="tab-content" id="dashboardTabsContent">
        <!-- MJO Tab -->
        <div class="tab-pane fade show active" id="mjo">
            <div class="row">
                <div class="col-md-6">
                    <h2>MOGREPS</h2>
                    <div class="control-group">
                        <label>Select Date:</label>
                        <div class="input-group">
                            <input type="text" id="mogrepsDatePicker" class="form-control" placeholder="Select date..." readonly>
                            <div class="input-group-append">
                                <button class="btn btn-primary" id="mogrepsDatePrevBtn">-</button>
                                <button class="btn btn-primary" id="mogrepsDateNextBtn">+</button>
                            </div>
                        </div>
                    </div>
                    <iframe id="mogrepsIframe"></iframe>
                </div>
                <div class="col-md-6">
                    <h2>GLOSEA</h2>
                    <div class="control-group">
                        <label>Select Date:</label>
                        <div class="input-group">
                            <input type="text" id="gloseaDatePicker" class="form-control" placeholder="Select date..." readonly>
                            <div class="input-group-append">
                                <button class="btn btn-primary" id="gloseaDatePrevBtn">-</button>
                                <button class="btn btn-primary" id="gloseaDateNextBtn">+</button>
                            </div>
                        </div>
                    </div>
                    <iframe id="gloseaIframe"></iframe>
                </div>
            </div>
        </div>

        <!-- Cold Surge Tab -->
        <div class="tab-pane fade" id="coldsurge">
            <h2>Cold Surge</h2>
            <div class="control-group">
                <div class="row">
                    <div class="col-md-4">
                        <label>Select Date:</label>
                        <div class="input-group">
                            <input type="text" id="coldSurgeDatePicker" class="form-control" placeholder="Select date..." readonly>
                            <div class="input-group-append">
                                <button class="btn btn-primary" id="coldSurgeDatePrevBtn">-</button>
                                <button class="btn btn-primary" id="coldSurgeDateNextBtn">+</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label>Select Lead Time:</label>
                        <div class="input-group">
                            <select id="leadTimeDropdown" class="form-control"></select>
                            <div class="input-group-append">
                                <button class="btn btn-primary" id="decrementLeadTimeBtn">-</button>
                                <button class="btn btn-primary" id="incrementLeadTimeBtn">+</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label>Select Precip. Threshold:</label>
                        <select id="thresholdDropdown" class="form-control">
                            <option value="10">10</option>
                            <option value="20">20</option>
                            <option value="30">30</option>
                        </select>
                    </div>
                </div>
            </div>
            <h3>MOGREPS</h3>
            <div class="row">
                <div class="col-md-6">
                    <iframe id="mogrepsEnsMeanIframe" style="height: 600px;"></iframe>
                </div>
                <div class="col-md-6">
                    <iframe id="mogrepsProbMapsIframe" style="height: 600px;"></iframe>
                </div>
            </div>
            <h3 style="margin-top: 20px;">GLOSEA</h3>
            <div class="row">
                <div class="col-md-6">
                    <iframe id="gloseaEnsMeanIframe" style="height: 600px;"></iframe>
                </div>
                <div class="col-md-6">
                    <iframe id="gloseaProbMapsIframe" style="height: 600px;"></iframe>
                </div>
            </div>
        </div>

        <!-- Equatorial Waves Tab -->
        <div class="tab-pane fade" id="eqwaves">
            <h2>Equatorial Waves</h2>
            <div class="control-group">
                <div class="row">
                    <div class="col-md-4">
                        <label>Select Date:</label>
                        <select id="eqwDateDropdown" class="form-control"></select>
                    </div>
                    <div class="col-md-4">
                        <label>Select Lead Time:</label>
                        <div class="input-group">
                            <select id="eqwLeadTimeDropdown" class="form-control"></select>
                            <div class="input-group-append">
                                <button class="btn btn-primary" id="eqwDecrementLeadTimeBtn">-</button>
                                <button class="btn btn-primary" id="eqwIncrementLeadTimeBtn">+</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label>Select Pressure Level:</label>
                        <select id="eqwWavePressureDropdown" class="form-control">
                            <option value="850">850 hPa</option>
                            <option value="200">200 hPa</option>
                        </select>
                    </div>
                </div>
            </div>
            <h3>MOGREPS</h3>
            <iframe id="eqwMogrepsEnsMeanIframe" style="min-height: 600px;"></iframe>
            <p style="margin-top: 20px;">Figure shows ensemble probability maps...</p>
        </div>

        <!-- Monsoon Indices Tab -->
        <div class="tab-pane fade" id="monsoonIndices">
            <h2>Monsoon Indices</h2>
            <div class="control-group">
                <label>Select Date:</label>
                <div class="input-group" style="max-width: 500px;">
                    <input type="text" id="monsoonIndicesDatePicker" class="form-control" placeholder="Select date..." readonly>
                    <div class="input-group-append">
                        <button class="btn btn-primary" id="monsoonIndicesDatePrevBtn">-</button>
                        <button class="btn btn-primary" id="monsoonIndicesDateNextBtn">+</button>
                    </div>
                </div>
            </div>
            <iframe id="monsoonIndicesIframe"></iframe>
            <p style="margin-top: 20px;">This method calculates the following indices...</p>
        </div>

        <!-- Convergence Lines Tab -->
        <div class="tab-pane fade" id="convLines">
            <h2>Convergence Lines</h2>
            <div class="control-group">
                <div class="row">
                    <div class="col-md-6">
                        <label>Select Date:</label>
                        <div class="input-group">
                            <input type="text" id="convLinesDatePicker" class="form-control" placeholder="Select date..." readonly>
                            <div class="input-group-append">
                                <button class="btn btn-primary" id="convLinesDatePrevBtn">-</button>
                                <button class="btn btn-primary" id="convLinesDateNextBtn">+</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label>Select Lead Time:</label>
                        <div class="input-group">
                            <select id="convLinesLeadTimeDropdown" class="form-control"></select>
                            <div class="input-group-append">
                                <button class="btn btn-primary" id="convLinesDecrementLeadTimeBtn">-</button>
                                <button class="btn btn-primary" id="convLinesIncrementLeadTimeBtn">+</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <iframe id="convLinesIframe"></iframe>
            <p style="margin-top: 20px;">
                Figure shows the ensemble probability of convergence lines detected using the Weller et al. (2017) method.
                The algorithm identifies convergence lines based on wind field analysis at 850 hPa level.
                Shaded areas indicate the probability (0-1) that a convergence line is present at that location across ensemble members.
            </p>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
<!-- Add Flatpickr JS for calendar -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script>
// Utility functions
const createDropdown = (id) => document.getElementById(id);
const createIframe = (id) => document.getElementById(id);

const navigateDropdown = (dropdown, direction) => {
    const newIndex = dropdown.selectedIndex + direction;
    if (newIndex >= 0 && newIndex < dropdown.options.length) {
        dropdown.selectedIndex = newIndex;
        dropdown.dispatchEvent(new Event('change'));
    }
};

const populateDropdown = (dropdown, dates, reverse = true) => {
    const orderedDates = reverse ? dates.reverse() : dates;
    orderedDates.forEach(date => {
        dropdown.appendChild(new Option(date, date));
    });
};

const fetchAndPopulate = (url, dropdown, callback) => {
    fetch(url)
        .then(response => response.json())
        .then(data => {
            populateDropdown(dropdown, data);
            if (callback) callback();
        })
        .catch(error => console.error(`Error fetching data from ${url}:`, error));
};

// Helper function to parse date from YYYYMMDD format
const parseDate = (dateStr) => {
    const year = dateStr.substring(0, 4);
    const month = dateStr.substring(4, 6);
    const day = dateStr.substring(6, 8);
    return new Date(year, parseInt(month) - 1, day);
};

// Helper function to format date to YYYYMMDD
const formatDate = (date) => {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}${month}${day}`;
};

// MJO Section with Calendar
const mjoSetup = () => {
    const mogrepsDatePicker = document.getElementById('mogrepsDatePicker');
    const gloseaDatePicker = document.getElementById('gloseaDatePicker');
    const mogrepsIframe = createIframe('mogrepsIframe');
    const gloseaIframe = createIframe('gloseaIframe');

    let mogrepsAvailableDates = [];
    let gloseaAvailableDates = [];
    let mogrepsFlatpickrInstance = null;
    let gloseaFlatpickrInstance = null;

    const updateMogreps = (dateStr) => {
        mogrepsIframe.src = `mjo/mogreps/plot_ens/MOGREPS_${dateStr}.html`;
    };

    const updateGlosea = (dateStr) => {
        gloseaIframe.src = `mjo/glosea/plot_ens/GLOSEA_${dateStr}.html`;
    };

    // Navigate MOGREPS date
    const navigateMogrepsDate = (direction) => {
        if (!mogrepsFlatpickrInstance || !mogrepsFlatpickrInstance.selectedDates[0]) return;
        
        const currentDate = mogrepsFlatpickrInstance.selectedDates[0];
        const currentDateStr = formatDate(currentDate);
        const currentIndex = mogrepsAvailableDates.indexOf(currentDateStr);
        
        if (currentIndex === -1) return;
        
        const newIndex = currentIndex + direction;
        if (newIndex >= 0 && newIndex < mogrepsAvailableDates.length) {
            const newDate = parseDate(mogrepsAvailableDates[newIndex]);
            mogrepsFlatpickrInstance.setDate(newDate);
            updateMogreps(mogrepsAvailableDates[newIndex]);
        }
    };

    // Navigate Glosea date
    const navigateGloseaDate = (direction) => {
        if (!gloseaFlatpickrInstance || !gloseaFlatpickrInstance.selectedDates[0]) return;
        
        const currentDate = gloseaFlatpickrInstance.selectedDates[0];
        const currentDateStr = formatDate(currentDate);
        const currentIndex = gloseaAvailableDates.indexOf(currentDateStr);
        
        if (currentIndex === -1) return;
        
        const newIndex = currentIndex + direction;
        if (newIndex >= 0 && newIndex < gloseaAvailableDates.length) {
            const newDate = parseDate(gloseaAvailableDates[newIndex]);
            gloseaFlatpickrInstance.setDate(newDate);
            updateGlosea(gloseaAvailableDates[newIndex]);
        }
    };

    // Fetch MOGREPS dates and setup calendar
    fetch('mjo/mogreps/plot_ens/mogreps_dates.json')
        .then(response => response.json())
        .then(data => {
            mogrepsAvailableDates = data;
            const enabledDates = data.map(d => parseDate(d));
            
            mogrepsFlatpickrInstance = flatpickr(mogrepsDatePicker, {
                enable: enabledDates,
                dateFormat: "Y-m-d",
                defaultDate: enabledDates[enabledDates.length - 1], // Most recent date
                onChange: function(selectedDates, dateStr, instance) {
                    const formattedDate = formatDate(selectedDates[0]);
                    updateMogreps(formattedDate);
                }
            });

            // Load initial plot
            updateMogreps(data[data.length - 1]);
        })
        .catch(error => console.error('Error fetching MOGREPS dates:', error));

    // Fetch GLOSEA dates and setup calendar
    fetch('mjo/glosea/plot_ens/glosea_dates.json')
        .then(response => response.json())
        .then(data => {
            gloseaAvailableDates = data;
            const enabledDates = data.map(d => parseDate(d));
            
            gloseaFlatpickrInstance = flatpickr(gloseaDatePicker, {
                enable: enabledDates,
                dateFormat: "Y-m-d",
                defaultDate: enabledDates[enabledDates.length - 1], // Most recent date
                onChange: function(selectedDates, dateStr, instance) {
                    const formattedDate = formatDate(selectedDates[0]);
                    updateGlosea(formattedDate);
                }
            });

            // Load initial plot
            updateGlosea(data[data.length - 1]);
        })
        .catch(error => console.error('Error fetching GLOSEA dates:', error));

    // Add event listeners for navigation buttons
    document.getElementById('mogrepsDatePrevBtn').addEventListener('click', () => navigateMogrepsDate(-1));
    document.getElementById('mogrepsDateNextBtn').addEventListener('click', () => navigateMogrepsDate(1));
    document.getElementById('gloseaDatePrevBtn').addEventListener('click', () => navigateGloseaDate(-1));
    document.getElementById('gloseaDateNextBtn').addEventListener('click', () => navigateGloseaDate(1));
};

// Cold Surge Section
const coldSurgeSetup = () => {
    const datePicker = document.getElementById('coldSurgeDatePicker');
    const leadTimeDropdown = createDropdown('leadTimeDropdown');
    const thresholdDropdown = createDropdown('thresholdDropdown');
    
    let availableDates = [];
    let flatpickrInstance = null;
    
    // Generate lead time options
    for (let hours = 24; hours <= 336; hours += 24) {
        leadTimeDropdown.appendChild(new Option(`${hours/24} day(s) (${hours}h)`, hours));
    }

    const updatePlots = () => {
        if (!flatpickrInstance || !flatpickrInstance.selectedDates[0]) return;
        
        const date = formatDate(flatpickrInstance.selectedDates[0]);
        const leadTime = leadTimeDropdown.value;
        const threshold = thresholdDropdown.value;

        createIframe('mogrepsEnsMeanIframe').src = `coldsurge/mogreps/plot_ens/${date}/Cold_surge_EnsMean_${date}_T${leadTime}h.html`;
        createIframe('mogrepsProbMapsIframe').src = `coldsurge/mogreps/plot_ens/${date}/Cold_surge_ProbMaps_${date}_T${leadTime}h_Pr${threshold}.html`;
        createIframe('gloseaEnsMeanIframe').src = `coldsurge/glosea/plot_ens/${date}/Cold_surge_EnsMean_${date}_T${leadTime}h.html`;
        createIframe('gloseaProbMapsIframe').src = `coldsurge/glosea/plot_ens/${date}/Cold_surge_ProbMaps_${date}_T${leadTime}h_Pr${threshold}.html`;
    };

    // Navigate date
    const navigateDate = (direction) => {
        if (!flatpickrInstance || !flatpickrInstance.selectedDates[0]) return;
        
        const currentDate = flatpickrInstance.selectedDates[0];
        const currentDateStr = formatDate(currentDate);
        const currentIndex = availableDates.indexOf(currentDateStr);
        
        if (currentIndex === -1) return;
        
        const newIndex = currentIndex + direction;
        if (newIndex >= 0 && newIndex < availableDates.length) {
            const newDate = parseDate(availableDates[newIndex]);
            flatpickrInstance.setDate(newDate);
            updatePlots();
        }
    };

    // Fetch dates and setup calendar
    fetch('coldsurge/mogreps/plot_ens/mogreps_ProbMaps_plot_dates.json')
        .then(response => response.json())
        .then(data => {
            availableDates = data;
            const enabledDates = data.map(d => parseDate(d));
            
            flatpickrInstance = flatpickr(datePicker, {
                enable: enabledDates,
                dateFormat: "Y-m-d",
                defaultDate: enabledDates[enabledDates.length - 1], // Most recent date
                onChange: function(selectedDates, dateStr, instance) {
                    updatePlots();
                }
            });

            // Load initial plot
            updatePlots();
        })
        .catch(error => console.error('Error fetching Cold Surge dates:', error));

    leadTimeDropdown.addEventListener('change', updatePlots);
    thresholdDropdown.addEventListener('change', updatePlots);

    // Date navigation buttons
    document.getElementById('coldSurgeDatePrevBtn').addEventListener('click', () => navigateDate(-1));
    document.getElementById('coldSurgeDateNextBtn').addEventListener('click', () => navigateDate(1));

    // Lead time navigation buttons
    document.getElementById('incrementLeadTimeBtn').addEventListener('click', () => {
        if (leadTimeDropdown.selectedIndex < leadTimeDropdown.options.length - 1) {
            leadTimeDropdown.selectedIndex++;
            updatePlots();
        }
    });

    document.getElementById('decrementLeadTimeBtn').addEventListener('click', () => {
        if (leadTimeDropdown.selectedIndex > 0) {
            leadTimeDropdown.selectedIndex--;
            updatePlots();
        }
    });
};

// Equatorial Waves Section
const eqWavesSetup = () => {
    const dateDropdown = createDropdown('eqwDateDropdown');
    const leadTimeDropdown = createDropdown('eqwLeadTimeDropdown');
    const pressureDropdown = createDropdown('eqwWavePressureDropdown');
    const iframe = createIframe('eqwMogrepsEnsMeanIframe');

    // Generate lead time options
    for (let hours = -96; hours <= 168; hours += 6) {
        leadTimeDropdown.appendChild(new Option(`${Math.abs(hours)} hours (${hours}h)`, hours));
    }
    leadTimeDropdown.value = '6';

    const updatePlot = () => {
        const date = dateDropdown.value.slice(0, -1);
        const leadTime = leadTimeDropdown.value;
        const pressure = pressureDropdown.value;
        iframe.src = `eqwaves/mogreps/plot_ens/${date}/AllWaves_${pressure}_EnsProb_${dateDropdown.value}_T${leadTime}h.html`;
    };

    fetch('eqwaves/mogreps/plot_ens/mogreps_eqw_ens_plot_dates.json')
        .then(response => response.json())
        .then(data => {
            data.reverse().forEach(date => {
                dateDropdown.appendChild(new Option(date + 'Z', date + 'Z'));
            });
            updatePlot();
        });

    dateDropdown.addEventListener('change', updatePlot);
    leadTimeDropdown.addEventListener('change', updatePlot);
    pressureDropdown.addEventListener('change', updatePlot);

    document.getElementById('eqwIncrementLeadTimeBtn').addEventListener('click', () => navigateDropdown(leadTimeDropdown, 1));
    document.getElementById('eqwDecrementLeadTimeBtn').addEventListener('click', () => navigateDropdown(leadTimeDropdown, -1));
};

// Monsoon Indices Section
const monsoonIndicesSetup = () => {
    const datePicker = document.getElementById('monsoonIndicesDatePicker');
    const iframe = createIframe('monsoonIndicesIframe');
    
    let availableDates = [];
    let flatpickrInstance = null;

    const updatePlot = () => {
        if (!flatpickrInstance || !flatpickrInstance.selectedDates[0]) return;
        
        const date = formatDate(flatpickrInstance.selectedDates[0]);
        iframe.src = `indices/mogreps/plot_ens/${date}/Monsoon_indices_${date}.html`;
    };

    // Navigate date
    const navigateDate = (direction) => {
        if (!flatpickrInstance || !flatpickrInstance.selectedDates[0]) return;
        
        const currentDate = flatpickrInstance.selectedDates[0];
        const currentDateStr = formatDate(currentDate);
        const currentIndex = availableDates.indexOf(currentDateStr);
        
        if (currentIndex === -1) return;
        
        const newIndex = currentIndex + direction;
        if (newIndex >= 0 && newIndex < availableDates.length) {
            const newDate = parseDate(availableDates[newIndex]);
            flatpickrInstance.setDate(newDate);
            updatePlot();
        }
    };

    // Fetch dates and setup calendar
    fetch('indices/mogreps/plot_ens/mogreps_indices_plot_dates.json')
        .then(response => response.json())
        .then(data => {
            availableDates = data;
            const enabledDates = data.map(d => parseDate(d));
            
            flatpickrInstance = flatpickr(datePicker, {
                enable: enabledDates,
                dateFormat: "Y-m-d",
                defaultDate: enabledDates[enabledDates.length - 1], // Most recent date
                onChange: function(selectedDates, dateStr, instance) {
                    updatePlot();
                }
            });

            // Load initial plot
            updatePlot();
        })
        .catch(error => console.error('Error fetching Monsoon Indices dates:', error));

    // Date navigation buttons
    document.getElementById('monsoonIndicesDatePrevBtn').addEventListener('click', () => navigateDate(-1));
    document.getElementById('monsoonIndicesDateNextBtn').addEventListener('click', () => navigateDate(1));
};

// Convergence Lines Section
const convLinesSetup = () => {
    const datePicker = document.getElementById('convLinesDatePicker');
    const leadTimeDropdown = createDropdown('convLinesLeadTimeDropdown');
    const iframe = createIframe('convLinesIframe');
    
    let availableDates = [];
    let flatpickrInstance = null;

    // Generate lead time options (24-hour intervals, 24 to 336 hours)
    for (let hours = 24; hours <= 336; hours += 24) {
        const days = hours / 24;
        leadTimeDropdown.appendChild(new Option(`Day ${days} (T+${hours}h)`, hours));
    }
    leadTimeDropdown.value = '24';

    const updatePlot = () => {
        if (!flatpickrInstance || !flatpickrInstance.selectedDates[0]) return;
        
        const date = formatDate(flatpickrInstance.selectedDates[0]);
        const leadTime = leadTimeDropdown.value;
        iframe.src = `convlines/mogreps/plot_ens/${date}/ConvLines_ProbMaps_${date}_T${leadTime}h.html`;
    };

    // Navigate date
    const navigateDate = (direction) => {
        if (!flatpickrInstance || !flatpickrInstance.selectedDates[0]) return;
        
        const currentDate = flatpickrInstance.selectedDates[0];
        const currentDateStr = formatDate(currentDate);
        const currentIndex = availableDates.indexOf(currentDateStr);
        
        if (currentIndex === -1) return;
        
        const newIndex = currentIndex + direction;
        if (newIndex >= 0 && newIndex < availableDates.length) {
            const newDate = parseDate(availableDates[newIndex]);
            flatpickrInstance.setDate(newDate);
            updatePlot();
        }
    };

    // Fetch dates and setup calendar
    fetch('convlines/mogreps/plot_ens/mogreps_convlines_plot_dates.json')
        .then(response => response.json())
        .then(data => {
            availableDates = data;
            const enabledDates = data.map(d => parseDate(d));
            
            flatpickrInstance = flatpickr(datePicker, {
                enable: enabledDates,
                dateFormat: "Y-m-d",
                defaultDate: enabledDates[enabledDates.length - 1], // Most recent date
                onChange: function(selectedDates, dateStr, instance) {
                    updatePlot();
                }
            });

            // Load initial plot
            updatePlot();
        })
        .catch(error => console.error('Error fetching Convergence Lines dates:', error));
    
    leadTimeDropdown.addEventListener('change', updatePlot);

    // Date navigation buttons
    document.getElementById('convLinesDatePrevBtn').addEventListener('click', () => navigateDate(-1));
    document.getElementById('convLinesDateNextBtn').addEventListener('click', () => navigateDate(1));
    
    // Lead time navigation buttons
    document.getElementById('convLinesIncrementLeadTimeBtn').addEventListener('click', () => {
        if (leadTimeDropdown.selectedIndex < leadTimeDropdown.options.length - 1) {
            leadTimeDropdown.selectedIndex++;
            updatePlot();
        }
    });
    
    document.getElementById('convLinesDecrementLeadTimeBtn').addEventListener('click', () => {
        if (leadTimeDropdown.selectedIndex > 0) {
            leadTimeDropdown.selectedIndex--;
            updatePlot();
        }
    });
};

// Initialize all sections
document.addEventListener('DOMContentLoaded', () => {
    mjoSetup();
    coldSurgeSetup();
    eqWavesSetup();
    monsoonIndicesSetup();
    convLinesSetup();
});
</script>

</body>
</html>
