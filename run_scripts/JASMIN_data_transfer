#!/bin/bash
# filepath: /home/users/prince.xavier/MJO/SALMON/run_scripts/JASMIN_data_transfer

# Source bash configuration
source /home/users/prince.xavier/.bashrc

# Configuration
REMOTE_USER="pxavier"
REMOTE_HOST="xfer-vm-01.jasmin.ac.uk"
LOCAL_BASE="/data/users/prince.xavier/SALMON/processed_SEA_data"
REMOTE_BASE="/gws/nopw/j04/seasia/public/realtime/SALMON"

# Rsync options
RSYNC_OPTS="-avz --progress --delete"

# Color output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to display status messages
log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

# Function to perform rsync with error handling
sync_data() {
    local source=$1
    local dest=$2
    local description=$3
    
    log_info "Syncing $description..."
    log_info "  Source: $source"
    log_info "  Dest: ${REMOTE_USER}@${REMOTE_HOST}:$dest"
    
    if [ ! -d "$source" ]; then
        log_error "Source directory does not exist: $source"
        return 1
    fi
    
    if rsync $RSYNC_OPTS "$source" "${REMOTE_USER}@${REMOTE_HOST}:$dest"; then
        log_info "✓ Successfully synced $description"
        return 0
    else
        log_error "✗ Failed to sync $description"
        return 1
    fi
}

# Main sync process
log_info "Starting SALMON data transfer to JASMIN..."
echo "================================================"

# Counter for success/failure
success_count=0
fail_count=0

# Transfer MOGREPS data for different areas
declare -a areas=("mjo" "coldsurge" "eqwaves" "indices" "convlines")
model="mogreps"

for area in "${areas[@]}"; do
    source="${LOCAL_BASE}/${model}/${area}/plot_ens/"
    dest="${REMOTE_BASE}/${area}/${model}/plot_ens/"
    
    if sync_data "$source" "$dest" "MOGREPS ${area}"; then
        ((success_count++))
    else
        ((fail_count++))
    fi
    echo ""
done

# Transfer MJO RMM files (currently commented out in original)
# Uncomment these lines when ready to transfer
# log_info "Transferring MJO RMM files..."
# source_rmm="${LOCAL_BASE}/${model}/mjo/rmms/"
# dest_rmm="${REMOTE_BASE}/mjo/${model}/rmms/"
# if sync_data "$source_rmm" "$dest_rmm" "MJO RMM files"; then
#     ((success_count++))
# else
#     ((fail_count++))
# fi
# echo ""

# Transfer GLOSEA MJO files
model="glosea"
source_glosea="${LOCAL_BASE}/${model}/mjo/plot_ens/"
dest_glosea="${REMOTE_BASE}/mjo/${model}/plot_ens/"

if sync_data "$source_glosea" "$dest_glosea" "GLOSEA MJO"; then
    ((success_count++))
else
    ((fail_count++))
fi
echo ""

# Transfer GLOSEA cold surge files
source_glosea_cs="${LOCAL_BASE}/${model}/coldsurge/plot_ens/"
dest_glosea_cs="${REMOTE_BASE}/coldsurge/${model}/plot_ens/"

if sync_data "$source_glosea_cs" "$dest_glosea_cs" "GLOSEA Cold Surge"; then
    ((success_count++))
else
    ((fail_count++))
fi
echo ""

# Transfer HTML dashboard (currently commented out in original)
# Uncomment when ready to transfer
# log_info "Transferring SALMON dashboard..."
# if rsync $RSYNC_OPTS SALMON.html "${REMOTE_USER}@${REMOTE_HOST}:${REMOTE_BASE}/"; then
#     log_info "✓ Successfully synced SALMON dashboard"
#     ((success_count++))
# else
#     log_error "✗ Failed to sync SALMON dashboard"
#     ((fail_count++))
# fi
# echo ""

# Summary
echo "================================================"
log_info "Transfer Summary:"
log_info "  Successful: ${success_count}"
if [ $fail_count -gt 0 ]; then
    log_error "  Failed: ${fail_count}"
    exit 1
else
    log_info "  Failed: ${fail_count}"
    log_info "All transfers completed successfully!"
    exit 0
fi
